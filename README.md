# Readme

This repository contains the source code for the paper *TLS-Anvil: Adapting Combinatorial Testing for TLS Libraries* that was submitted to the *31st USENIX Security Symposium (2022)*. In the following we provide a short tutorial, how to use *TLS-Anvil* to analyze OpenSSL 1.1.1i, running inside a Docker container provided by the *TLS-Docker-Library*.

The repository includes prebuilt Docker images, since multiple dependencies are required (TLS-Attacker including subprojects) to compile TLS-Anvil.

## How To analyze OpenSSL 1.1.1i
**Requirements:**
* Docker

1. Generate certificates for the example server
    ```bash
    ./TLS-Docker-Library/setup.sh
    ```
2. Analyze OpenSSL 1.1.1i using TLS-Anvil.
    1. Server analysis (~38 minutes):  
        ```bash
        mkdir -p results/openssl_server
        cd results/openssl_server

        docker network create tls-anvil

        # start the openssl server image
        docker run \
            -d \
            --rm \
            --name openssl-server \
            --network tls-anvil \
            -v cert-data:/certs/ \
            ghcr.io/tls-anonymous/openssl-server:1.1.1i \
            -port 8443 \
            -cert /certs/rsa2048cert.pem \
            -key /certs/rsa2048key.pem

        # run TLS-Anvil
        docker run \
            --rm \
            -it \
            -v $(pwd):/output/ \
            --name tls-anvil \
            --network tls-anvil \
            ghcr.io/tls-anonymous/tls-anvil:latest \
            -outputFolder ./ \
            -parallelHandshakes 1 \
            -strength 1 \
            -identifier openssl-server \
            server \
            -connect openssl-server:8443 \
            -doNotSendSNIExtension
        ```
    1. Client analysis (~15 minutes):
        ```bash
        mkdir -p results/openssl_client
        cd results/openssl_client
        docker network create tls-anvil

        # run TLS-Anvil
        docker run \
            --rm \
            -v $(pwd):/output/ \
            --network tls-anvil \
            --name tls-anvil \
            ghcr.io/tls-anonymous/tls-anvil:latest \
            -outputFolder ./ \
            -parallelHandshakes 3 \
            -parallelTests 3 \
            -strength 1 \
            -identifier openssl-client \
            client \
            -port 8443 \
            -triggerScript curl --connect-timeout 2 openssl-client:8090/trigger

        # start the openssl client image inside a new terminal
        docker run \
            -d \
            --rm \
            --name openssl-client \
            --network tls-anvil \
            ghcr.io/tls-anonymous/openssl-client:1.1.1i \
            -connect tls-anvil:8443
        ```
2. Analyze the TLS-Anvil report using the TLS-Anvil-Result-Analyzer (web application).
    1. Build and and run the application.
    ```bash
    cd TLS-Anvil-Result-Analyzer

    docker-compose pull
    docker-compose up -d
    ```
    1. Upload the results generated by TLS-Anvil to the analyzer application
    ```bash
    cd results
    docker run \
        --rm \
        -it \
        --network host \
        -v $(pwd):/upload \
        ghcr.io/tls-anonymous/tls-anvil-result-uploader:latest
    ```
    1. Open your web browser at [http://localhost:5000](http://localhost:5000).
    1. Click `Analyzer` in the navbar and select the uploaded report from the dropdown menu on the top left.
        * If the menu is empty, reload the page.
    1. The result for each test template is presented in the table.
    1. The table rows are clickable and show the results for each test case, i.e. each performed handshake.
        1. Click on a test result icon of a test case to view the recorded PCAP dump for the handshake as well as additional information about the handshake. `DerivationContainer`, for example, shows the test input for the test case, generated by the combinatorial testing algorithm.
        1. Click on the table column head (first row) to see more information about the test template, including the failure inducing combinations.


**Note:** Step two can be simplified by using the *TLS-Anvil-Large-Scale-Evaluator*. This tool coordinates the start of the TLS-Anvil and SUT Docker images. Feel free to start it (requires Java >= 8). To analyze OpenSSL server and client in parallel the following command can be used.
```bash 
cd bin/TLS-Anvil-Large-Scale-Evaluator
docker pull ghcr.io/tls-anonymous/openssl-client:1.1.1i
docker pull ghcr.io/tls-anonymous/openssl-server:1.1.1i
docker pull ghcr.io/tls-anonymous/tls-anvil:latest
java -jar TLS-Anvil-Large-Scale-Evaluator.jar --testsuiteImage ghcr.io/tls-anonymous/tls-anvil:latest -i OPENSSL -v 1.1.1i -e TESTSUITE -s 1 --ram 2
```


## TLS-Docker-Library
To build additional Docker images from the TLS-Docker-Library, the following steps need to be performed.
```bash
cd TLS-Docker-Library
./setup.sh

cd images
# Build openssl 1.1.1i images locally
./build-everything.py -l openssl -i 1.1.1i
```


## Repository Structure

* `TLS-Anvil/`
    * Source code for the test templates of TLS-Anvil.
* `TLS-Test-Framework/`
    * Source code of the test framework used by TLS-Anvil that handles the test execution.
* `TLS-Anvil-Result-Analyzer/`
    * Source code for a web application that is used for analyzing the test reports produced by TLS-Anvil.
* `TLS-Attacker-Development/`
    * Source code of TLS-Attacker including modifications needed by TLS-Anvil.
* `TLS-Docker-Library/`
    * Source code, mainly Dockerfiles, for building multiple TLS-Libraries in multiple versions.
* `TLS-Anvil-Large-Scale-Evaluator/`
    * Source code to analyze multiple dockerized TLS-Libraries with TLS-Anvil.
* `bin/`
    * Precompiled Jar files for TLS-Anvil and the TLS-Anvil-Large-Scale-Evaluator

